{% extends "layout.html" %}

{% block title %}NIDS - Network Intrusion Detection System{% endblock %}

{% block content %}
<div class="container mt-5">
    <!-- Hero Section -->
    <div class="row mb-5">
        <div class="col-lg-12 text-center">
            <div class="hero-section p-5 bg-gradient rounded-3" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));">
                <h1 class="display-4 text-white mb-4">
                    <i class="bi bi-shield-check me-3"></i>
                    Network Intrusion Detection System
                </h1>
                <p class="lead text-white mb-4">
                    AI-powered real-time network security monitoring with advanced machine learning algorithms
                </p>
                <div class="d-flex justify-content-center gap-3 flex-wrap">
                    <a href="/dashboard" class="btn btn-light btn-lg btn-custom">
                        <i class="bi bi-graph-up me-2"></i>
                        View Dashboard
                    </a>
                    <button class="btn btn-outline-light btn-lg btn-custom" onclick="startQuickDemo()">
                        <i class="bi bi-play-circle me-2"></i>
                        Quick Demo
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- System Status Cards -->
    <div class="row mb-5">
        <div class="col-md-3 mb-4">
            <div class="card h-100 metric-card">
                <div class="card-body">
                    <div class="metric-value text-success" id="systemStatus">
                        <i class="bi bi-check-circle-fill"></i>
                    </div>
                    <div class="metric-label">System Status</div>
                    <small class="text-muted" id="statusText">All systems operational</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card h-100 metric-card">
                <div class="card-body">
                    <div class="metric-value text-info" id="packetsCount">0</div>
                    <div class="metric-label">Packets Analyzed</div>
                    <small class="text-muted">Last 24 hours</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card h-100 metric-card">
                <div class="card-body">
                    <div class="metric-value text-warning" id="threatsDetected">0</div>
                    <div class="metric-label">Threats Detected</div>
                    <small class="text-muted">Last 24 hours</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-4">
            <div class="card h-100 metric-card">
                <div class="card-body">
                    <div class="metric-value text-primary" id="modelAccuracy">94.2%</div>
                    <div class="metric-label">Model Accuracy</div>
                    <small class="text-muted">Random Forest + PCA</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Features Section -->
    <div class="row mb-5">
        <div class="col-lg-12">
            <h2 class="text-center mb-5">Advanced Security Features</h2>
        </div>
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card h-100 text-center">
                <div class="card-body">
                    <div class="mb-3">
                        <i class="bi bi-cpu-fill text-primary" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="card-title">AI-Powered Detection</h5>
                    <p class="card-text">Multiple machine learning algorithms including Random Forest, LSTM, and Transformer models for accurate threat detection.</p>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card h-100 text-center">
                <div class="card-body">
                    <div class="mb-3">
                        <i class="bi bi-lightning-fill text-warning" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="card-title">Real-Time Monitoring</h5>
                    <p class="card-text">Live packet analysis with WebSocket-based dashboard updates for instant threat visibility and response.</p>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card h-100 text-center">
                <div class="card-body">
                    <div class="mb-3">
                        <i class="bi bi-eye-fill text-info" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="card-title">Behavioral Analysis</h5>
                    <p class="card-text">Advanced anomaly detection using behavioral profiling and threat intelligence integration.</p>
                </div>
            </div>
        </div>
        <div class="col-md-6 col-lg-3 mb-4">
            <div class="card h-100 text-center">
                <div class="card-body">
                    <div class="mb-3">
                        <i class="bi bi-shield-lock-fill text-success" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="card-title">Enterprise Security</h5>
                    <p class="card-text">JWT authentication, role-based access control, and comprehensive audit logging for enterprise environments.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-5">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-gear-fill me-2"></i>
                        Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 col-lg-3 mb-3">
                            <button class="btn btn-outline-primary w-100 btn-custom" onclick="testPrediction()">
                                <i class="bi bi-play-circle me-2"></i>
                                Test Prediction
                            </button>
                        </div>
                        <div class="col-md-6 col-lg-3 mb-3">
                            <button class="btn btn-outline-success w-100 btn-custom" onclick="startMonitoring()">
                                <i class="bi bi-activity me-2"></i>
                                Start Monitoring
                            </button>
                        </div>
                        <div class="col-md-6 col-lg-3 mb-3">
                            <button class="btn btn-outline-info w-100 btn-custom" onclick="trainModels()">
                                <i class="bi bi-cpu me-2"></i>
                                Train Models
                            </button>
                        </div>
                        <div class="col-md-6 col-lg-3 mb-3">
                            <button class="btn btn-outline-warning w-100 btn-custom" onclick="exportLogs()">
                                <i class="bi bi-download me-2"></i>
                                Export Logs
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="row mb-5">
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-activity me-2"></i>
                        Recent Activity
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshActivity()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div id="activityFeed" class="packet-stream">
                        <div class="text-center text-muted">
                            <i class="bi bi-hourglass-split"></i>
                            <p>Loading recent activity...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        System Information
                    </h5>
                </div>
                <div class="card-body">
                    <div id="systemInfo">
                        <div class="mb-3">
                            <strong>Version:</strong>
                            <span class="badge bg-primary">v2.0.0</span>
                        </div>
                        <div class="mb-3">
                            <strong>ML Models:</strong>
                            <div id="modelList">
                                <span class="badge bg-success me-1">Random Forest</span>
                                <span class="badge bg-info me-1">LSTM</span>
                                <span class="badge bg-warning me-1">Transformer</span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <strong>CPU Usage:</strong>
                            <div class="progress mt-1">
                                <div id="cpuProgress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <strong>Memory Usage:</strong>
                            <div class="progress mt-1">
                                <div id="memoryProgress" class="progress-bar bg-info" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <strong>Uptime:</strong>
                            <span id="uptime" class="text-muted">Calculating...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Demo Modal -->
<div class="modal fade" id="demoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-play-circle me-2"></i>
                    NIDS Quick Demo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Simulation Controls</h6>
                        <div class="mb-3">
                            <label class="form-label">Packets per second</label>
                            <input type="range" class="form-range" id="ppsSlider" min="1" max="20" value="5">
                            <span id="ppsValue">5</span> pps
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Threat Level</label>
                            <select class="form-select" id="threatLevel">
                                <option value="low">Low (10% attacks)</option>
                                <option value="medium" selected>Medium (30% attacks)</option>
                                <option value="high">High (60% attacks)</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" id="startDemoBtn" onclick="startDemo()">
                            <i class="bi bi-play"></i> Start Demo
                        </button>
                        <button class="btn btn-secondary" id="stopDemoBtn" onclick="stopDemo()" disabled>
                            <i class="bi bi-stop"></i> Stop Demo
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h6>Live Demo Feed</h6>
                        <div id="demoFeed" class="packet-stream" style="height: 300px;">
                            <div class="text-center text-muted">
                                <i class="bi bi-play-circle"></i>
                                <p>Click "Start Demo" to begin simulation</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize WebSocket connection
    const socket = initializeWebSocket();
    let monitoringActive = false;
    let demoActive = false;
    const startTime = Date.now();

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadSystemStatus();
        loadRecentActivity();
        updateSystemInfo();
        
        // Set up periodic updates
        setInterval(updateSystemInfo, 30000); // Every 30 seconds
        setInterval(updateUptime, 1000); // Every second
        
        // PPS slider update
        const ppsSlider = document.getElementById('ppsSlider');
        const ppsValue = document.getElementById('ppsValue');
        if (ppsSlider && ppsValue) {
            ppsSlider.addEventListener('input', function() {
                ppsValue.textContent = this.value;
            });
        }
    });

    // WebSocket event handlers
    if (socket) {
        socket.on('packet_detected', function(data) {
            addActivityItem(data);
            updateMetrics();
        });

        socket.on('status_update', function(data) {
            updateSystemMetrics(data.system);
        });
    }

    async function loadSystemStatus() {
        try {
            const data = await apiCall('/status');
            updateSystemMetrics(data.system);
            updateModelInfo(data.ml_model);
            
            // Update status indicator
            const statusIcon = document.getElementById('systemStatus');
            const statusText = document.getElementById('statusText');
            if (statusIcon && statusText) {
                statusIcon.innerHTML = '<i class="bi bi-check-circle-fill"></i>';
                statusIcon.className = 'metric-value text-success';
                statusText.textContent = 'All systems operational';
            }
        } catch (error) {
            console.error('Failed to load system status:', error);
            const statusIcon = document.getElementById('systemStatus');
            const statusText = document.getElementById('statusText');
            if (statusIcon && statusText) {
                statusIcon.innerHTML = '<i class="bi bi-x-circle-fill"></i>';
                statusIcon.className = 'metric-value text-danger';
                statusText.textContent = 'System error detected';
            }
        }
    }

    async function loadRecentActivity() {
        try {
            const data = await apiCall('/logs?limit=10');
            const activityFeed = document.getElementById('activityFeed');
            
            if (data.logs && data.logs.length > 0) {
                activityFeed.innerHTML = '';
                data.logs.forEach(log => {
                    addActivityItem({
                        timestamp: log.timestamp,
                        src_ip: log.source_ip,
                        dst_ip: log.destination_ip,
                        protocol: log.protocol,
                        prediction: log.attack_type,
                        confidence: log.confidence,
                        is_attack: log.is_alert
                    });
                });
            } else {
                activityFeed.innerHTML = `
                    <div class="text-center text-muted">
                        <i class="bi bi-inbox"></i>
                        <p>No recent activity</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Failed to load recent activity:', error);
            document.getElementById('activityFeed').innerHTML = `
                <div class="text-center text-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    <p>Failed to load activity</p>
                </div>
            `;
        }
    }

    function updateSystemMetrics(systemData) {
        if (!systemData) return;
        
        // Update CPU progress
        const cpuProgress = document.getElementById('cpuProgress');
        if (cpuProgress) {
            cpuProgress.style.width = systemData.cpu_percent + '%';
            cpuProgress.textContent = systemData.cpu_percent.toFixed(1) + '%';
        }
        
        // Update memory progress
        const memoryProgress = document.getElementById('memoryProgress');
        if (memoryProgress) {
            memoryProgress.style.width = systemData.memory_percent + '%';
            memoryProgress.textContent = systemData.memory_percent.toFixed(1) + '%';
        }
    }

    function updateModelInfo(modelData) {
        if (!modelData) return;
        
        const modelAccuracy = document.getElementById('modelAccuracy');
        if (modelAccuracy && modelData.accuracy) {
            modelAccuracy.textContent = (modelData.accuracy * 100).toFixed(1) + '%';
        }
    }

    async function updateMetrics() {
        try {
            const stats = await apiCall('/statistics');
            
            // Update packets count
            const packetsCount = document.getElementById('packetsCount');
            if (packetsCount) {
                packetsCount.textContent = formatNumber(stats.total_count || 0);
            }
            
            // Update threats detected
            const threatsDetected = document.getElementById('threatsDetected');
            if (threatsDetected) {
                const attacks = stats.attack_distribution ? 
                    stats.attack_distribution.reduce((sum, item) => sum + (item.count || 0), 0) : 0;
                threatsDetected.textContent = formatNumber(attacks);
            }
        } catch (error) {
            console.error('Failed to update metrics:', error);
        }
    }

    function updateSystemInfo() {
        updateUptime();
        loadSystemStatus();
    }

    function updateUptime() {
        const uptimeElement = document.getElementById('uptime');
        if (uptimeElement) {
            const uptime = Date.now() - startTime;
            const hours = Math.floor(uptime / (1000 * 60 * 60));
            const minutes = Math.floor((uptime % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((uptime % (1000 * 60)) / 1000);
            uptimeElement.textContent = `${hours}h ${minutes}m ${seconds}s`;
        }
    }

    function addActivityItem(data) {
        const activityFeed = document.getElementById('activityFeed');
        if (!activityFeed) return;
        
        const item = document.createElement('div');
        const itemClass = data.is_attack ? 'packet-attack' : 'packet-normal';
        const icon = data.is_attack ? 'bi-exclamation-triangle-fill' : 'bi-check-circle-fill';
        
        item.className = `packet-item ${itemClass}`;
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi ${icon} me-2"></i>
                    <strong>${data.src_ip || 'unknown'}</strong> → <strong>${data.dst_ip || 'unknown'}</strong>
                    <span class="badge bg-secondary ms-2">${data.protocol || 'unknown'}</span>
                </div>
                <div class="text-end">
                    <small class="text-muted">${formatTime(data.timestamp)}</small><br>
                    <span class="badge ${data.is_attack ? 'bg-danger' : 'bg-success'}">${data.prediction}</span>
                    <small class="text-muted">(${(data.confidence * 100).toFixed(1)}%)</small>
                </div>
            </div>
        `;
        
        // Add to top of feed
        activityFeed.insertBefore(item, activityFeed.firstChild);
        
        // Remove old items (keep last 20)
        while (activityFeed.children.length > 20) {
            activityFeed.removeChild(activityFeed.lastChild);
        }
        
        // Show alert for high-confidence attacks
        if (data.is_attack && data.confidence > 0.8) {
            showAlert(`High-confidence attack detected from ${data.src_ip}`, 'danger');
        }
    }

    function refreshActivity() {
        loadRecentActivity();
        showAlert('Activity refreshed', 'success');
    }

    // Quick Action Functions
    async function testPrediction() {
        showLoading('Testing prediction...', 'Generating test packet and running ML models');
        
        try {
            // Generate test packet data
            const testPacket = {
                duration: Math.random() * 100,
                protocol_type: Math.random() > 0.5 ? 'tcp' : 'udp',
                service: 'http',
                flag: 'SF',
                src_bytes: Math.floor(Math.random() * 1000),
                dst_bytes: Math.floor(Math.random() * 1000),
                land: 0,
                wrong_fragment: 0,
                urgent: 0,
                hot: 0,
                num_failed_logins: 0,
                logged_in: 1,
                num_compromised: 0,
                root_shell: 0,
                su_attempted: 0
            };
            
            const result = await apiCall('/predict', {
                method: 'POST',
                body: JSON.stringify(testPacket)
            });
            
            hideLoading();
            
            const alertType = result.is_attack ? 'warning' : 'success';
            const message = `Test prediction: ${result.attack_type} (${(result.confidence * 100).toFixed(1)}% confidence)`;
            showAlert(message, alertType);
            
        } catch (error) {
            hideLoading();
            showAlert('Test prediction failed: ' + error.message, 'danger');
        }
    }

    async function startMonitoring() {
        if (monitoringActive) {
            await stopMonitoring();
            return;
        }
        
        try {
            showLoading('Starting monitoring...', 'Initializing packet capture and ML models');
            
            const result = await apiCall('/realtime/start', {
                method: 'POST',
                body: JSON.stringify({
                    use_simulation: true,
                    packets_per_second: 5
                })
            });
            
            hideLoading();
            monitoringActive = true;
            
            // Update button
            const button = event.target;
            button.innerHTML = '<i class="bi bi-stop-circle me-2"></i>Stop Monitoring';
            button.className = 'btn btn-outline-danger w-100 btn-custom';
            
            showAlert('Real-time monitoring started', 'success');
            
        } catch (error) {
            hideLoading();
            showAlert('Failed to start monitoring: ' + error.message, 'danger');
        }
    }

    async function stopMonitoring() {
        try {
            await apiCall('/realtime/stop', { method: 'POST' });
            
            monitoringActive = false;
            
            // Update button
            const button = event.target;
            button.innerHTML = '<i class="bi bi-activity me-2"></i>Start Monitoring';
            button.className = 'btn btn-outline-success w-100 btn-custom';
            
            showAlert('Monitoring stopped', 'info');
            
        } catch (error) {
            showAlert('Failed to stop monitoring: ' + error.message, 'danger');
        }
    }

    async function trainModels() {
        if (!confirm('Model training may take several minutes. Continue?')) {
            return;
        }
        
        showLoading('Training models...', 'This may take several minutes depending on dataset size');
        
        try {
            const result = await apiCall('/train', {
                method: 'POST',
                body: JSON.stringify({
                    use_sample: true,
                    models: ['random_forest', 'decision_tree', 'naive_bayes'],
                    hyperparameter_tuning: false
                })
            });
            
            hideLoading();
            showAlert(`Model training completed. Best model: ${result.best_model}`, 'success');
            
            // Refresh model info
            setTimeout(() => {
                loadSystemStatus();
            }, 1000);
            
        } catch (error) {
            hideLoading();
            showAlert('Model training failed: ' + error.message, 'danger');
        }
    }

    async function exportLogs() {
        showLoading('Exporting logs...', 'Generating CSV file');
        
        try {
            const result = await apiCall('/export/logs');
            
            // Create download link
            const blob = new Blob([result.csv_data], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = result.filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            hideLoading();
            showAlert('Logs exported successfully', 'success');
            
        } catch (error) {
            hideLoading();
            showAlert('Export failed: ' + error.message, 'danger');
        }
    }

    // Demo Functions
    function startQuickDemo() {
        const modal = new bootstrap.Modal(document.getElementById('demoModal'));
        modal.show();
    }

    async function startDemo() {
        if (demoActive) return;
        
        const pps = document.getElementById('ppsSlider').value;
        const threatLevel = document.getElementById('threatLevel').value;
        
        try {
            await apiCall('/realtime/start', {
                method: 'POST',
                body: JSON.stringify({
                    use_simulation: true,
                    packets_per_second: parseInt(pps),
                    threat_level: threatLevel
                })
            });
            
            demoActive = true;
            document.getElementById('startDemoBtn').disabled = true;
            document.getElementById('stopDemoBtn').disabled = false;
            
            // Clear demo feed
            document.getElementById('demoFeed').innerHTML = '';
            
            showAlert('Demo started', 'success');
            
        } catch (error) {
            showAlert('Failed to start demo: ' + error.message, 'danger');
        }
    }

    async function stopDemo() {
        if (!demoActive) return;
        
        try {
            await apiCall('/realtime/stop', { method: 'POST' });
            
            demoActive = false;
            document.getElementById('startDemoBtn').disabled = false;
            document.getElementById('stopDemoBtn').disabled = true;
            
            showAlert('Demo stopped', 'info');
            
        } catch (error) {
            showAlert('Failed to stop demo: ' + error.message, 'danger');
        }
    }

    // Add demo feed updates
    if (socket) {
        socket.on('packet_detected', function(data) {
            if (demoActive) {
                const demoFeed = document.getElementById('demoFeed');
                if (demoFeed) {
                    addActivityItem(data);
                    // Also add to demo feed
                    const item = document.createElement('div');
                    const itemClass = data.is_attack ? 'packet-attack' : 'packet-normal';
                    item.className = `packet-item ${itemClass}`;
                    item.innerHTML = `
                        <small>
                            <strong>${data.src_ip}</strong> → <strong>${data.dst_ip}</strong>
                            <span class="badge ${data.is_attack ? 'bg-danger' : 'bg-success'} ms-2">${data.prediction}</span>
                        </small>
                    `;
                    demoFeed.insertBefore(item, demoFeed.firstChild);
                    
                    // Keep only last 15 items
                    while (demoFeed.children.length > 15) {
                        demoFeed.removeChild(demoFeed.lastChild);
                    }
                }
            }
        });
    }
</script>
{% endblock %}